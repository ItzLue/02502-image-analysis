% 02502 - Image Analysis DTU % Exercise 6 on Advanced segmentation% Topic: Fisherman's Linear discriminant analysis for segmentation%%The exercise is to perform advanced segmentation of two brain tissue types. % To improve the segmentation result over the simpler intensity histogram thresholding methods we % will use two input features compared to a single. % The two input features are two different image modalities acquired on the same brain. %% The two tissue types to be segmented are: %   I) The White Matter (WM) is the tissue type that contain the brain network - like the cables %      in the internet. %.     The  WM ensure the communication flow between functional brain regions. %   II) The Grey Matter (GM) is the tissue type that contain the cell bodies at the end of the %       brain network and are the functional units in the brain. %.      The functional units are like CPUs in the computer. %.      They are processing our sensorial input and are determining a reacting %       to these. It could be to start running.% % Provided data:% ex6_ImgData2Load.mat contain all image and ROI data which are loaded into the % variables:%   ImgT1 - One axial slice of brain using T1W MRI acquisition%   ImgT2 - One axial slice of brain using T2W MRI acquisition%   ROI_WM - Binary training data for class 1: Expert identification of voxels belonging to % tissue type: White Matter%   ROI_GM - Binary training data for class 2: Expert identification of voxels belonging to % tissue type: Grey Matter%% LDA-m  Is matlab function that realise the Fisher's linear discriminant analyse as described in Note for lecture 6%% Exercise -  You simply go step-by-step and fill the command% lines and answer/discuss the questions.%% October 2020, March 2021, Tim Dyrby, tbdy@dtu.dk%Clean up variables and figuresclear allclose all% 0) Set path to working directory using cd('path') where image data and% the LDA.m function are placed. load('ex6_ImagData2Load.mat')%% Exercise 1) Display both the T1 and T2 images, their 1D and 2D histograms and scatter plots % Tips: Use the 'imagesc()', 'histogram()' and 'scatter()' functions% Add relevant title and label for each axis. One can use 'subplot()' to show more% subfigures in the same figure.% Remove intensities from background voxels for 1D and 2D histograms using find()%% Q1: What is the intensity threshold that can separate the GM and WM classes (roughly) from the 1D histograms? %% Q2: Can the GM and WM intensity classes be observed in the 2D histogram% and scatter plot? %% Exercise 2) Place trainings examples i.e. ROI_WM and ROI_GM into variables C1 and C2 representing  class 1 and class 2 respectively. % Show in a figure the manually expert drawings of the C1 and C2 training% examples. Tips: use 'imagesc()'%% Q3: Does the ROI drawings look like what you expect from an expert? %% Exercise 3) For each binary training ROI find the corresponding training examples in ImgT1 and ImgT2% Later these will be extracted for LDA training. % Tips: Use the 'find()' function which return the index to voxels in the image full filling e.g. intensity values >0 hence belong to a given class. % Name the index variables qC1 and qC2, respectively.%% Q4: What is the difference between the 1D histogram of the training examples and the 1D histogram of the whole image? Is the difference expected?  %% Exercise 4) Make a training data vector (X) and target class vector (T) as input for the 'LDA()' function. % T and X should have the same length of data points.% - X: training data vector should first include all data points for class 1 and% then the data points for class 2. Data points are the two input features ImgT1, ImgT2% - T: Target class identifier for X where '0' are Class 1 and a '1' is Class 0.%% Exercise 5) Make a scatter plot of the training points of the two input features for class 1 and class 2. % Show Class 1 and 2 as green and black circles, respectively. % Add relevant title and labels to axis%% Q5: How does the class separation appear in the 2D scatter plot compared with 1D histogram. Is it better?%% Exercise 6)Train the linear discriminant classifier using the Fisher discriminant function and estimate % the weight-vector coefficient W (i.e. w0 and w) for classification given X and T by using the 'W=LDA()' function. % The LDA function outputs W=[[w01 w1]; [w02 w2]] for class 1 and 2 respectively.% Tip: Read the Bishop note on Chapter 4. W = LDA(X,T);%% Exercise 7) Apply the linear discriminant classifier i.e. perform multi-modal classification % using the trained weight-vector W for each class: It calculates the linear score Y for *all* image data points % within the brain slice i.e. y(x)= w+w0. Actually, y(x) is the log(P(Ci|x)).Xall=[ImgT1(:),ImgT2(:)];Y = [ones(length(ImgT1(:)),1) Xall] * W'; %% Exercise 8) Perform multi-modal classification: % Calculate the posterior probability i.e. P(X|C1) of a data point belonging to class 1% Note: Using Bayes [Eq 1]: Since y(x) is the log of the posterior probability [Eq2] % we take exp(y(x)) to get P(X|C1)=(P(X|mu,var)P(C1))) and divide with the marginal probability (P(X)) % as normalisation factor.    PosteriorProb = exp(Y) ./ repmat(sum(exp(Y),2),[1 2]);  %% Exercise 9) Apply segmentation: Find all voxles in the T1w and T2w image with P(X|C1)>0.5 % as belonging to Class 1 using the 'find()' function. % Similarly, find all voxels belonging to class 2.qSegC1=find(PosteriorProb(:,1)>0.5);qSegC2=find(PosteriorProb(:,1)<=0.5);%% Exercise 10) Show scatter plot of segmentation results as in 6). %% Q6: Can you identify where the hyper plan is placed i.e. y(x)=0? %% Q7: Is the linear hyper plane positioned as you expected or would a non-linear hyper plan perform better?%% Q8: Would segmentation be as good as using a single image modality using%     thresholding?%% Q9: From the scatter plot does the segmentation results make sense? Are the two tissue types segmented correctly .%% Exercise 11) Show segmentation results and training examples of class 1 and 2 in sub figures.  %% Q10: Are the training examples representative for the% segmentation results? Are you surprised that so few training examples perform% so well? Do you need to be an anatomical expert to draw these?%% Q11: Compare the segmentation results with the original image. Is the segmentation results satisfactory? Why not?%% Q12: Is one class completely wrong segmented? What is the problem?